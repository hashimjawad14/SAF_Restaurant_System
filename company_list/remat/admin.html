<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Beverage Orders Dashboard</title>

    <!-- Use a crisp modern font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- Reset & base --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }

      /* === Page background: elegant light -> medium dark hybrid ===
         Soft airy base with subtle teal/indigo radial accents.
         Keeps depth but is much lighter overall for readability.
      */
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: radial-gradient(
            1000px 450px at 8% 12%,
            rgba(99, 102, 241, 0.12),
            transparent 8%
          ),
          radial-gradient(
            900px 420px at 92% 88%,
            rgba(16, 185, 129, 0.1),
            transparent 8%
          ),
          linear-gradient(180deg, #f7fafc 0%, #eef2f6 60%, #e6ebf2 100%);
        color: #0f1724; /* dark slate for primary text */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        min-height: 100vh;
        padding: 28px;
        transition: background 0.4s ease;
      }

      /* container */
      .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* header: glassy card with subtle shadow and darker text */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        padding: 20px;
        border-radius: 14px;
        backdrop-filter: blur(8px) saturate(120%);
        background: rgba(
          255,
          255,
          255,
          0.68
        ); /* lighter card to contrast with page */
        border: 1px solid rgba(30, 41, 59, 0.06);
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        overflow: hidden;
        animation: fadeInUp 0.5s ease both;
      }

      .header-left {
        min-width: 0;
      }
      .dashboard-title {
        font-size: 22px;
        font-weight: 800;
        color: #0b1220; /* strong dark */
        line-height: 1;
        letter-spacing: -0.4px;
      }
      .dashboard-subtitle {
        font-size: 13px;
        color: #475569;
        margin-top: 6px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* status indicator ‚Äî bright accent but readable text */
      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        color: #06203c;
        background: rgba(99, 255, 186, 0.95);
        box-shadow: 0 6px 18px rgba(91, 198, 255, 0.08),
          inset 0 -4px 16px rgba(255, 255, 255, 0.04);
        font-size: 13px;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(8, 10, 10, 0.9);
        box-shadow: 0 0 10px rgba(91, 198, 255, 0.9);
        animation: pulse 1.8s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* controls / filters card ‚Äî elevated glass */
      .controls {
        display: block;
        padding: 18px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid rgba(30, 41, 59, 0.06);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
        animation: fadeInUp 0.55s ease both;
      }

      .controls-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 150px;
      }
      .control-group label {
        color: #475569;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }

      select,
      input[type="date"],
      input[type="number"],
      input {
        appearance: none;
        padding: 10px 12px;
        border-radius: 10px;
        background: #ffffff;
        color: #0f1724;
        border: 1px solid rgba(20, 24, 28, 0.06);
        font-size: 14px;
        outline: none;
        transition: all 0.18s ease;
        box-shadow: 0 2px 8px rgba(15, 23, 36, 0.03) inset;
      }
      select:focus,
      input:focus {
        transform: translateY(-2px);
        border-color: rgba(91, 198, 255, 0.9);
        box-shadow: 0 8px 30px rgba(91, 198, 255, 0.08),
          0 1px 0 rgba(255, 255, 255, 0.02) inset;
        background: #ffffff;
      }

      /* primary and secondary action buttons */
      .refresh-btn,
      .clear-btn,
      .action-btn,
      .tiny-btn {
        cursor: pointer;
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        font-size: 13px;
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          opacity 0.12s ease;
      }
      .refresh-btn {
        background: linear-gradient(90deg, #bbf7d0, #10b981);
        color: black;
        box-shadow: 0 8px 30px rgba(96, 165, 250, 0.1);
      }
      .refresh-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 50px rgba(96, 165, 250, 0.12);
      }

      .clear-btn {
        background: linear-gradient(90deg, #ff7a7a, #ef4444);
        color: #fff;
        box-shadow: 0 8px 30px rgba(239, 68, 68, 0.08);
      }
      .clear-btn:hover {
        transform: translateY(-3px);
      }

      .tiny-btn {
        padding: 8px 12px;
        border-radius: 10px;
        background: #ffffff;
        color: #0f1724;
        border: 1px solid rgba(30, 41, 59, 0.06);
        box-shadow: 0 4px 18px rgba(2, 6, 23, 0.04);
      }
      .tiny-btn:hover {
        transform: translateY(-3px);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        animation: fadeInUp 0.6s ease both;
      }

      .stat-card {
        padding: 16px;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(250, 251, 253, 0.96)
        );
        border: 1px solid rgba(18, 23, 28, 0.04);
        box-shadow: 0 10px 30px rgba(15, 23, 36, 0.04);
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .stat-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 22px 60px rgba(15, 23, 36, 0.06);
      }

      .stat-number {
        font-size: 28px;
        color: #0b1220;
        font-weight: 800;
        letter-spacing: -0.6px;
      }
      .stat-label {
        font-size: 12px;
        color: #475569;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }

      /* Orders container */
      .orders-container {
        padding: 18px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid rgba(18, 23, 28, 0.04);
        box-shadow: 0 12px 40px rgba(15, 23, 36, 0.05);
        animation: fadeInUp 0.62s ease both;
      }

      .orders-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 16px;
      }
      .orders-title {
        font-size: 16px;
        font-weight: 800;
        color: #0b1220;
      }
      .orders-count {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 800;
        color: white;
        background: #077487;
        box-shadow: 0 8px 26px rgba(124, 58, 237, 0.06);
      }

      .orders-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
        max-height: 56vh;
        overflow-y: auto;
        padding-right: 6px;
      }
      .orders-list::-webkit-scrollbar {
        width: 8px;
      }
      .orders-list::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 36, 0.08);
        border-radius: 8px;
      }

      /* Order card (keep same classes & structure so JS works)
         Cards are intentionally lighter than background so they stand out.
      */
      .order-card {
        padding: 18px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 36, 0.04);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(250, 251, 253, 0.96)
        );
        display: block;
        transition: transform 0.18s cubic-bezier(0.2, 0.9, 0.3, 1),
          box-shadow 0.18s ease, border-color 0.18s ease;
        box-shadow: 0 8px 22px rgba(15, 23, 36, 0.04);
      }
      .order-card:hover {
        transform: translateY(-6px) scale(1.002);
        box-shadow: 0 30px 70px rgba(15, 23, 36, 0.06);
      }

      /* statuses ‚Äî keep class names (pending, in-progress, completed) */
      .order-card.pending {
        border-left: 6px solid #facc15;
        background: linear-gradient(180deg, #fff9eb, #fffefc);
      }
      .order-card.in-progress {
        border-left: 6px solid #3b82f6;
        background: linear-gradient(180deg, #f5fbff, #ffffff);
      }
      .order-card.completed {
        border-left: 6px solid #10b981;
        background: linear-gradient(180deg, #f6fffa, #ffffff);
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 14px;
      }

      .order-info {
        flex: 1;
        min-width: 0;
      }
      .order-id {
        color: #0b1220;
        font-weight: 800;
        font-size: 16px;
      }
      .order-meta {
        color: #475569;
        font-size: 13px;
        display: flex;
        gap: 12px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .order-status-wrapper {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 120px;
      }

      .order-status {
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        display: inline-block;
        color: #061124;
        background: linear-gradient(90deg, #d1fae5, #60a5fa);
        box-shadow: 0 6px 18px rgba(96, 165, 250, 0.06);
      }
      .order-status.pending {
        background: linear-gradient(90deg, #fde047, #f59e0b);
        color: #06203c;
      }
      .order-status.in-progress {
        background: linear-gradient(90deg, #bfdbfe, #60a5fa);
        color: #06203c;
      }
      .order-status.completed {
        background: linear-gradient(90deg, #bbf7d0, #10b981);
        color: #06203c;
      }

      .order-time-taken {
        font-size: 12px;
        color: #334155;
        background: rgba(15, 23, 36, 0.03);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
        box-shadow: 0 3px 8px rgba(15, 23, 36, 0.03);
      }

      .order-items {
        margin-bottom: 12px;
      }
      .items-title {
        font-size: 13px;
        font-weight: 700;
        color: #0b1220;
        margin-bottom: 8px;
      }
      .items-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .item-tag {
        padding: 6px 10px;
        border-radius: 999px;
        background: #077487;
        color: #fff;
        font-weight: 700;
        font-size: 13px;
        box-shadow: 0 6px 18px rgba(124, 58, 237, 0.06);
      }

      .order-note-display {
        margin: 10px 0;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(250, 251, 253, 0.96)
        );
        border-left: 3px solid rgba(102, 126, 234, 0.6);
        padding: 10px 12px;
        border-radius: 8px;
        color: #374151;
        font-size: 13px;
      }

      .order-rating {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .order-rating h4 {
        font-size: 13px;
        color: #0b1220;
        font-weight: 800;
        margin-bottom: 4px;
      }

      .order-rating .rating-block,
      .order-rating .review-block {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 8px;
        padding: 10px 12px;
        border-left: 3px solid rgba(250, 204, 21, 0.6);
        box-shadow: 0 4px 12px rgba(15, 23, 36, 0.05);
      }

      .order-rating .stars {
        font-size: 16px;
        color: #f59e0b;
        letter-spacing: 2px;
      }

      .order-rating .review {
        background: transparent;
        color: #334155;
        font-size: 13px;
        line-height: 1.4;
      }

      .order-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 10px 14px;
        font-size: 14px;
        margin-top: 17px;
        font-weight: 800;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 36, 0.04);
        background: #ececec;
        color: #0b1220;
        cursor: pointer;
        transition: transform 0.14s ease, box-shadow 0.14s ease,
          opacity 0.14s ease;
      }
      .action-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 14px 40px rgba(15, 23, 36, 0.06);
      }

      .start-btn {
        background: linear-gradient(90deg, #c596f6, #7c3aed);
        color: #fff;
        border: none;
        box-shadow: 0 12px 36px rgba(124, 58, 237, 0.06);
      }
      .complete-btn {
        background: linear-gradient(90deg, #34d399, #10b981);
        color: #04201a;
        border: none;
        box-shadow: 0 12px 36px rgba(16, 185, 129, 0.06);
      }
      .delete-btn {
        background: linear-gradient(90deg, #ff7a7a, #ef4444);
        color: #fff;
        border: none;
        box-shadow: 0 12px 36px rgba(239, 68, 68, 0.06);
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }
      .empty-state svg {
        width: 72px;
        height: 72px;
        margin-bottom: 14px;
        opacity: 0.6;
        color: rgba(15, 23, 36, 0.06);
      }

      /* notification */
      .notification {
        position: fixed;
        top: 22px;
        right: 22px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        padding: 14px 18px;
        box-shadow: 0 20px 60px rgba(15, 23, 36, 0.08);
        border-left: 4px solid rgba(16, 185, 129, 0.95);
        transform: translateX(420px);
        transition: transform 0.35s cubic-bezier(0.2, 0.9, 0.3, 1),
          opacity 0.25s ease;
        z-index: 1200;
      }
      .notification.show {
        transform: translateX(0);
      }
      .notification-title {
        font-weight: 800;
        color: #0b1220;
        margin-bottom: 4px;
      }
      .notification-message {
        color: #334155;
        font-size: 13px;
      }

      /* small helpers */
      .tiny-muted {
        color: #6b7280;
        font-size: 12px;
      }

      /* responsive */
      @media (max-width: 980px) {
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
        .orders-list {
          max-height: 46vh;
        }
      }
      @media (max-width: 720px) {
        body {
          padding: 14px;
        }
        .dashboard-container {
          gap: 14px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .controls-row {
          flex-direction: column;
          align-items: stretch;
        }
        .control-group {
          width: 100%;
          min-width: 0;
        }
        .orders-list {
          max-height: 48vh;
        }
        .order-header {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        .order-status-wrapper {
          align-items: flex-start;
        }
      }

      /* subtle animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="header">
        <div class="header-left">
          <h1 class="dashboard-title">Admin Dashboard</h1>
          <p class="dashboard-subtitle">Remat Al-Riyadh</p>
        </div>
        <div class="header-right">
          <button id="deskSettingsBtn" class="tiny-btn" title="Configure desks">
            Desk Settings
          </button>
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>Live Updates</span>
          </div>
          <button
            id="logoutBtn"
            class="tiny-btn"
            style="background: #ef4444; color: white"
          >
            Logout
          </button>
        </div>
      </div>

      <!-- Add this before closing </body> -->
      <audio id="notificationSound" preload="auto">
        <source src="/ding.mp3" type="audio/mpeg" />
        <!-- <source src="noti_saf.mp3" type="audio/mpeg" /> -->
      </audio>

      <div class="controls">
        <div class="controls-row">
          <div class="control-group">
            <label for="statusFilter">Filter by Status</label>
            <select id="statusFilter">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <div class="control-group">
            <label for="dateFilter">Filter by Date</label>
            <input type="date" id="dateFilter" />
          </div>

          <div class="control-group">
            <label for="deskFilter">Filter by Desk</label>
            <input
              type="number"
              id="deskFilter"
              placeholder="Enter desk number"
              min="1"
            />
          </div>
          <div class="control-group">
            <label>&nbsp;</label>
            <button class="refresh-btn" id="refreshBtn">Refresh Orders</button>
          </div>
          <div class="control-group">
            <label>&nbsp;</label>
            <button class="clear-btn" id="clearBtn">Clear All Orders</button>
          </div>
          <button id="statsBtn" class="action-btn">üìä Statistics</button>
        </div>
      </div>

      <div class="stats" id="statsContainer">
        <div class="stat-card">
          <div class="stat-number" id="totalOrders">0</div>
          <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingOrders">0</div>
          <div class="stat-label">Pending Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="inProgressOrders">0</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completedOrders">0</div>
          <div class="stat-label">Completed Today</div>
        </div>
      </div>

      <div class="orders-container">
        <div class="orders-header">
          <h2 class="orders-title">Recent Orders</h2>
          <span class="orders-count" id="ordersCount">0 orders</span>
        </div>
        <div class="orders-list" id="ordersList">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1ZM10 6a2 2 0 0 1 4 0v1h-4V6Zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10Z"
              />
            </svg>
            <h3>No orders yet</h3>
            <p>Orders will appear here as they come in</p>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">
      <div class="notification-title" id="notificationTitle">New Order!</div>
      <div class="notification-message" id="notificationMessage">
        <!-- Order received from Desk #1 -->
      </div>
    </div>

    <script nonce="123456">
      const COMPANY_CODE = "remat"; // üëà set manually per company

      if (localStorage.getItem(`loggedInFor_${COMPANY_CODE}`) !== "true") {
        window.location.href = "login.html";
      }

      function logout() {
        localStorage.removeItem(`loggedInFor_${COMPANY_CODE}`);
        window.location.href = "login.html";
      }

      function goToSettings() {
        // Build the URL with the current company‚Äôs order_menu.html and #settings
        const newUrl = `/company_list/${COMPANY_CODE}/order_menu.html#settings`;
        window.location.href = newUrl;
      }

      document.getElementById("statsBtn").addEventListener("click", () => {
        window.location.href = `/company_list/${COMPANY_CODE}/stats.html`;
      });

      document
        .getElementById("deskSettingsBtn")
        .addEventListener("click", goToSettings);
      document.getElementById("logoutBtn").addEventListener("click", logout);

      // --- Helper: robust parse of order timestamp into a Date (local-aware) ---
      function parseOrderTimestampToDate(ts) {
        if (ts == null) return null;

        // Already a Date
        if (ts instanceof Date) {
          return isNaN(ts) ? null : ts;
        }

        // Number or numeric-string (epoch seconds or ms)
        if (typeof ts === "number" || /^\d+$/.test(String(ts))) {
          let n = Number(ts);
          // convert 10-digit seconds to ms
          if (String(n).length === 10) n = n * 1000;
          const d = new Date(n);
          return isNaN(d) ? null : d;
        }

        let s = String(ts).trim();

        // If format is "YYYY-MM-DD" ‚Äî treat as local midnight
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
          const d = new Date(s + "T00:00:00"); // local midnight
          if (!isNaN(d)) return d;
        }

        // If there's a space between date and time, convert to 'T' to help parsing:
        // "2025-10-06 12:34:56" => "2025-10-06T12:34:56"
        s = s.replace(/\s+/, "T");

        // If timezone present (Z or +HH:MM or +HHMM), Date will parse it and convert to local
        if (
          /[zZ]$/.test(s) ||
          /[+\-]\d{2}:\d{2}$/.test(s) ||
          /[+\-]\d{4}$/.test(s)
        ) {
          const d = new Date(s);
          if (!isNaN(d)) return d;
        }

        // Otherwise, treat the string as local (no timezone) by letting Date parse it (modern browsers treat "YYYY-MM-DDTHH:mm:ss" as local)
        const dFallback = new Date(s);
        return isNaN(dFallback) ? null : dFallback;
      }

      // Helper: start/end of day (local)
      function startOfLocalDayFromYYYYMMDD(yyyyMmDd) {
        const [y, m, d] = yyyyMmDd.split("-").map(Number);
        return new Date(y, m - 1, d, 0, 0, 0, 0);
      }
      function endOfLocalDayFromYYYYMMDD(yyyyMmDd) {
        const [y, m, d] = yyyyMmDd.split("-").map(Number);
        return new Date(y, m - 1, d, 23, 59, 59, 999);
      }

      function unlockAudio() {
        const sound = document.getElementById("notificationSound");
        if (!sound) return;
        sound.volume = 1.0;
        sound
          .play()
          .then(() => {
            sound.pause();
            sound.currentTime = 0;
            console.log("üîî Audio unlocked and ready");
          })
          .catch((err) => console.warn("Unlock failed:", err));
      }

      window.addEventListener("click", unlockAudio, { once: true });
      window.addEventListener("keydown", unlockAudio, { once: true });

      class DashboardApp {
        constructor() {
          this.orders = [];
          this.filteredOrders = [];

          // === Detect companyId from URL ===
          const urlParams = new URLSearchParams(window.location.search);
          this.companyId = COMPANY_CODE; // üëà always use manual code
          this.apiBase = "/api/orders";
          // this.apiBase = "http://localhost:4000/api/orders";

          this.apiEndpoint = `${this.apiBase}?company=${this.companyId}`;

          // Desk range (can be customized)
          this.startDesk = 1;
          this.endDesk = 160;

          // === Define custom desk numbers here ===
          this.customDesks = [];

          this.firstLoad = true;
          this.allowedDesks = this.buildAllowedDeskSet();
          this.pollInterval = null;

          this.init();
        }

        // buildAllowedDeskSet() {
        //   const set = new Set();
        //   for (let i = this.startDesk; i <= this.endDesk; i++) {
        //     set.add(String(i));
        //     set.add(`DESK${i}`);
        //     set.add(`desk${i}`);
        //     set.add(`id-${i}`);
        //   }
        //   return set;
        // }

        buildAllowedDeskSet() {
          const set = new Set();

          // Add range desks
          for (let i = this.startDesk; i <= this.endDesk; i++) {
            set.add(String(i));
            set.add(`DESK${i}`);
            set.add(`desk${i}`);
          }

          // Add custom desks
          for (const d of this.customDesks) {
            set.add(String(d));
            set.add(`DESK${d}`);
            set.add(`desk${d}`);
          }

          return set;
        }

        getDeskNumber(order) {
          const d = order?.desk != null ? String(order.desk).trim() : "";
          if (/^\d+$/.test(d)) return parseInt(d, 10);

          const sa =
            order?.serviceArea != null ? String(order.serviceArea).trim() : "";
          const m = sa.match(/desk\s*([0-9]+)/i);
          if (m) return parseInt(m[1], 10);

          return null;
        }

        isDeskInAllowedRange(order) {
          const n = this.getDeskNumber(order);
          if (n != null) return n >= this.startDesk && n <= this.endDesk;

          const d = order?.desk != null ? String(order.desk).trim() : "";
          const sa =
            order?.serviceArea != null ? String(order.serviceArea).trim() : "";
          return this.allowedDesks.has(d) || this.allowedDesks.has(sa);
        }

        getOrdersInRange() {
          return this.orders.filter((o) => this.isDeskInAllowedRange(o));
        }

        init() {
          this.loadOrders();
          this.attachEventListeners();
          const list = document.getElementById("ordersList");
          list.addEventListener("click", (e) => {
            const btn = e.target.closest(".action-btn");
            if (!btn) return;
            const card = e.target.closest(".order-card");
            if (!card) return;
            const orderId = card.dataset.orderId;
            const action = btn.dataset.action;
            this.handleOrderAction(orderId, action);
          });

          this.startPolling();
          this.updateStats();
        }

        attachEventListeners() {
          document
            .getElementById("statusFilter")
            ?.addEventListener("change", () => this.filterOrders());
          document
            .getElementById("dateFilter")
            ?.addEventListener("change", () => this.filterOrders());
          document
            .getElementById("dateFilter")
            .addEventListener("dblclick", () => {
              document.getElementById("dateFilter").value = "";
              dashboard.filterOrders();
            });

          document
            .getElementById("deskFilter")
            ?.addEventListener("input", () => this.filterOrders());
          document
            .getElementById("refreshBtn")
            ?.addEventListener("click", () => this.loadOrders());
          document
            .getElementById("clearBtn")
            ?.addEventListener("click", () => this.clearAllOrders());
        }

        startPolling() {
          this.pollInterval = setInterval(() => {
            this.loadOrders(true);
          }, 3000);
        }

        async loadOrders(silent = false) {
          try {
            const res = await fetch(this.apiEndpoint);
            if (!res.ok) throw new Error(`GET failed: ${res.status}`);
            const newOrders = await res.json();
            this.handleOrdersUpdate(newOrders, silent);
          } catch (error) {
            console.warn(
              "API not available, using localStorage fallback",
              error
            );
            const localOrders = JSON.parse(
              localStorage.getItem("dashboardOrders") || "[]"
            );
            this.handleOrdersUpdate(localOrders, silent);
          }
        }

        handleOrdersUpdate(newOrders, silent) {
          const prevIds = new Set(this.orders.map((o) => String(o.id)));

          // if (!this.firstLoad) {
          // const newlyAddedInRange = [...newOrders]
          //   .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          //   .find(
          //     (o) =>
          //       !prevIds.has(String(o.id)) && this.isDeskInAllowedRange(o)
          //   );

          // if (newlyAddedInRange) {
          //   const deskNum = this.getDeskNumber(newlyAddedInRange);
          //   const label =
          //     deskNum != null
          //       ? `Desk #${deskNum}`
          //       : newlyAddedInRange.desk ??
          //         newlyAddedInRange.serviceArea ??
          //         "-";
          //   this.showNotification(
          //     "New Order!",
          //     `Order received from ${label}`
          //   );
          // }

          //   const newlyAddedInRange = [...newOrders]
          //     .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          //     .find(
          //       (o) =>
          //         !prevIds.has(String(o.id)) &&
          //         this.isDeskInAllowedRange(o) &&
          //         o.status === "pending" // üëà only pending orders trigger notification
          //     );

          //   if (newlyAddedInRange) {
          //     const deskNum = this.getDeskNumber(newlyAddedInRange);
          //     const label =
          //       deskNum != null
          //         ? `Desk #${deskNum}`
          //         : newlyAddedInRange.desk ??
          //           newlyAddedInRange.serviceArea ??
          //           "-";
          //     this.showNotification(
          //       "New Order!",
          //       `Order received from ${label}`
          //     );
          //   }
          // }

          // this.orders = [...newOrders].sort(
          //   (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          // );
          // this.filterOrders();
          // this.updateStats();

          // this.firstLoad = false;

          // Load previously seen order IDs (persistent across reloads)
          const seenIds = new Set(
            JSON.parse(localStorage.getItem("seenOrderIds") || "[]")
          );

          if (!this.firstLoad) {
            const newlyAddedInRange = [...newOrders]
              .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
              .find(
                (o) =>
                  !prevIds.has(String(o.id)) &&
                  !seenIds.has(String(o.id)) && // üëà ignore already-seen orders
                  this.isDeskInAllowedRange(o) &&
                  o.status === "pending" // üëà only pending orders trigger
              );

            if (newlyAddedInRange) {
              const deskNum = this.getDeskNumber(newlyAddedInRange);
              const label =
                deskNum != null
                  ? `Desk #${deskNum}`
                  : newlyAddedInRange.desk ??
                    newlyAddedInRange.serviceArea ??
                    "-";
              this.showNotification(
                "New Order!",
                `Order received from ${label}`
              );
            }
          }

          // ‚úÖ Update seen orders in localStorage
          const seenList = [
            ...new Set([...seenIds, ...newOrders.map((o) => String(o.id))]),
          ];
          localStorage.setItem("seenOrderIds", JSON.stringify(seenList));

          this.orders = [...newOrders].sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );
          this.filterOrders();
          this.updateStats();
          this.firstLoad = false;
        }

        filterOrders() {
          const statusFilter = document.getElementById("statusFilter").value;
          const deskFilter = document.getElementById("deskFilter").value;
          const dateFilter = document.getElementById("dateFilter").value; // "YYYY-MM-DD" or ""

          const base = this.getOrdersInRange();

          // Precompute range if dateFilter is set
          let rangeStart = null;
          let rangeEnd = null;
          if (dateFilter) {
            rangeStart = startOfLocalDayFromYYYYMMDD(dateFilter);
            rangeEnd = endOfLocalDayFromYYYYMMDD(dateFilter);
          }

          this.filteredOrders = base.filter((order) => {
            const statusMatch =
              statusFilter === "all" || order.status === statusFilter;

            const deskMatchInput =
              !deskFilter ||
              String(this.getDeskNumber(order) ?? order.desk) ===
                String(deskFilter);

            // fallback to common alternate timestamp keys
            const tsRaw =
              order.timestamp ??
              order.createdAt ??
              order.time ??
              order.date ??
              null;

            // If no date filter selected, accept immediately (so other filters still apply)
            if (!dateFilter) {
              return statusMatch && deskMatchInput;
            }

            // parse timestamp to Date
            const orderDate = parseOrderTimestampToDate(tsRaw);
            if (!orderDate) {
              // no valid timestamp -> treat as not matching the selected date
              return false && statusMatch && deskMatchInput;
            }

            const dateMatch = orderDate >= rangeStart && orderDate <= rangeEnd;

            return statusMatch && deskMatchInput && dateMatch;
          });

          this.renderOrders();
        }

        renderOrders() {
          const ordersList = document.getElementById("ordersList");
          const ordersCount = document.getElementById("ordersCount");

          if (this.filteredOrders.length === 0) {
            ordersList.innerHTML = `
                  <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1Z"/>
                    </svg>
                    <h3>No orders found</h3>
                    <p>Try adjusting filters or wait for new orders</p>
                  </div>`;
            ordersCount.textContent = "0 orders";
            return;
          }

          ordersCount.textContent = `${this.filteredOrders.length} order${
            this.filteredOrders.length !== 1 ? "s" : ""
          }`;
          ordersList.innerHTML = this.filteredOrders
            .map((order) => this.renderOrderCard(order))
            .join("");
          // this.attachOrderActions();
        }

        renderOrderCard(order) {
          const formattedTime = new Date(order.timestamp).toLocaleString();
          const deskNum = this.getDeskNumber(order);
          const deskLabel =
            deskNum != null
              ? `Desk #${deskNum}`
              : order.desk
              ? `Desk #${order.desk}`
              : order.serviceArea || "Desk";

          const itemCounts = {};
          (order.items || []).forEach((item) => {
            itemCounts[item] = (itemCounts[item] || 0) + 1;
          });

          const itemsHtml = Object.entries(itemCounts)
            .map(
              ([name, count]) =>
                `<span class="item-tag">${name}${
                  count > 1 ? ` √ó ${count}` : ""
                }</span>`
            )
            .join("");

          // Helper: format a duration in ms -> "1h 2m 5s" (no leading zeros)
          function formatDuration(ms) {
            if (!Number.isFinite(ms) || ms <= 0) return null;
            let totalSec = Math.floor(ms / 1000);
            const days = Math.floor(totalSec / 86400);
            totalSec %= 86400;
            const hrs = Math.floor(totalSec / 3600);
            totalSec %= 3600;
            const mins = Math.floor(totalSec / 60);
            const secs = totalSec % 60;
            const parts = [];
            if (days) parts.push(`${days}d`);
            if (hrs) parts.push(`${hrs}h`);
            if (mins) parts.push(`${mins}m`);
            if (secs || parts.length === 0) parts.push(`${secs}s`);
            return parts.join(" ");
          }

          // Determine valid start and end times
          const start = order.startedAt ? new Date(order.startedAt) : null;
          const end = order.completedAt ? new Date(order.completedAt) : null;

          // Build time-taken HTML (sibling to the status)
          let timeTakenHtml = "";
          if (
            order.status === "completed" &&
            start &&
            end &&
            !isNaN(start) &&
            !isNaN(end) &&
            end >= start
          ) {
            const diffMs = end - start;
            const pretty = formatDuration(diffMs);
            if (pretty)
              timeTakenHtml = `<div class="order-time-taken">‚è±Ô∏è Time Taken: ${pretty}</div>`;
          } else if (order.status === "in-progress" && start && !isNaN(start)) {
            // show elapsed so far (will update when UI re-renders/polls)
            const diffMs = Date.now() - start.getTime();
            const pretty = formatDuration(diffMs);
            if (pretty)
              timeTakenHtml = `<div class="order-time-taken">‚è±Ô∏è In progress: ${pretty} so far</div>`;
          } else {
            // if status completed but dates invalid, optionally show N/A -- keep empty so it doesn't clutter
            timeTakenHtml = "";
          }

          // ‚≠ê Build rating stars if rating exists
          let ratingHtml = "";
          if (order.rating && order.rating.stars) {
            const stars = Array.from({ length: 5 }, (_, i) =>
              i < order.rating.stars ? "‚òÖ" : "‚òÜ"
            ).join("");
            ratingHtml = `
  <div class="order-rating">
    <div class="rating-block">
      <h4>Rating:</h4>
      <div class="stars">${stars}</div>
    </div>
    ${
      order.rating.review
        ? `<div class="review-block">
             <h4>Review:</h4>
             <div class="review">${order.rating.review}</div>
           </div>`
        : ""
    }
  </div>`;
          }

          return `
          <div class="order-card ${order.status}" data-order-id="${String(
            order.id
          )}">
            <div class="order-header">
              <div class="order-info">
                <div class="order-id">${deskLabel}</div>
                <div class="order-meta">
                  <span>üìç ${order.location ?? "-"}</span>
                  <span>üïê ${formattedTime}</span>
                  <span>üë• ${
                    (order.teaboyName || order.serviceAreaName) ?? "-"
                  }</span>
                </div>
              </div>

              <!-- status + timeTaken are siblings; timeTaken appears below the flag -->
              <div class="order-status-wrapper">
                <div class="order-status ${
                  order.status
                }">${order.status.replace("-", " ")}</div>
                ${timeTakenHtml}
              </div>
            </div>

            <div class="order-items">
              <div class="items-title">Items Ordered:</div>
              <div class="items-list">${itemsHtml}</div>
            </div>

            ${
              order.orderNote
                ? `<div class="order-note-display"><strong>Note:</strong> ${order.orderNote}</div>`
                : ""
            }
            ${ratingHtml}
            <div class="order-actions">
              ${
                order.status === "pending"
                  ? '<button class="action-btn start-btn" data-action="start">Start Order</button>'
                  : ""
              }
              ${
                order.status === "in-progress"
                  ? '<button class="action-btn complete-btn" data-action="complete">Mark Complete</button>'
                  : ""
              }
              <button class="action-btn delete-btn" data-action="delete">Delete Order</button>
            </div>
          </div>`;
        }

        attachOrderActions() {
          const list = document.getElementById("ordersList");
          list.onclick = null;
          list.addEventListener("click", (e) => {
            const btn = e.target.closest(".action-btn");
            if (!btn) return;
            const card = e.target.closest(".order-card");
            if (!card) return;
            const orderId = card.dataset.orderId;
            const action = btn.dataset.action;
            this.handleOrderAction(orderId, action);
          });
        }

        async handleOrderAction(orderId, action) {
          // prevent multiple rapid calls
          if (this._actionInProgress) {
            console.warn("Action already in progress, ignoring:", action);
            return;
          }
          this._actionInProgress = true;

          const order = this.orders.find(
            (o) => String(o.id) === String(orderId)
          );
          if (!order || !this.isDeskInAllowedRange(order)) {
            this._actionInProgress = false;
            return;
          }

          try {
            let res;
            if (action === "start" || action === "complete") {
              order.status = action === "start" ? "in-progress" : "completed";
              this.filterOrders();
              this.updateStats();

              console.log(`Updating order ${orderId} ‚Üí ${order.status}`);

              res = await fetch(
                `${this.apiBase}/${encodeURIComponent(
                  orderId
                )}?company=${encodeURIComponent(this.companyId)}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ status: order.status }),
                }
              );
            } else if (action === "delete") {
              if (!confirm("Delete this order?")) {
                this._actionInProgress = false;
                return;
              }

              this.orders = this.orders.filter(
                (o) => String(o.id) !== String(orderId)
              );
              this.filterOrders();
              this.updateStats();

              console.log(`Deleting order ${orderId}`);

              res = await fetch(
                `${this.apiBase}/${encodeURIComponent(
                  orderId
                )}?company=${encodeURIComponent(this.companyId)}`,
                {
                  method: "DELETE",
                }
              );
            }

            if (res && !res.ok) {
              console.error(`${action} failed: ${res.status}`);
              return; // ‚ùå don‚Äôt overwrite orders if failed
            }

            await this.loadOrders(true);
          } catch (err) {
            console.error("Action failed:", err);
          } finally {
            this._actionInProgress = false; // ‚úÖ unlock
          }
        }

        async saveOrders() {
          try {
            const response = await fetch(
              `${this.apiBase}/bulk?company=${encodeURIComponent(
                this.companyId
              )}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(this.orders),
              }
            );
            if (!response.ok) throw new Error("API bulk save failed");
          } catch (error) {
            console.warn("API not available, saving to localStorage");
            localStorage.setItem(
              "dashboardOrders",
              JSON.stringify(this.orders)
            );
          }
        }

        updateStats() {
          const inRange = this.getOrdersInRange();
          const total = inRange.length;
          const pending = inRange.filter((o) => o.status === "pending").length;
          const inProgress = inRange.filter(
            (o) => o.status === "in-progress"
          ).length;
          const today = new Date().toDateString();
          const completedToday = inRange.filter(
            (o) =>
              o.status === "completed" &&
              new Date(o.timestamp).toDateString() === today
          ).length;

          document.getElementById("totalOrders").textContent = total;
          document.getElementById("pendingOrders").textContent = pending;
          document.getElementById("inProgressOrders").textContent = inProgress;
          document.getElementById("completedOrders").textContent =
            completedToday;
        }

        async clearAllOrders() {
          if (
            !confirm(
              `Delete all orders for desks ${this.startDesk}-${this.endDesk}?`
            )
          )
            return;
          try {
            const inRange = this.getOrdersInRange();
            const ids = inRange.map((o) => o.id);
            const idSet = new Set(ids.map(String));
            this.orders = this.orders.filter((o) => !idSet.has(String(o.id)));
            this.filterOrders();
            this.updateStats();

            const results = await Promise.allSettled(
              ids.map((id) =>
                fetch(
                  `${this.apiBase}/${encodeURIComponent(
                    id
                  )}?company=${encodeURIComponent(this.companyId)}`,
                  {
                    method: "DELETE",
                  }
                )
              )
            );
            const allOk = results.every(
              (r) => r.status === "fulfilled" && r.value?.ok
            );
            if (!allOk) throw new Error("Some deletes failed");
            this.showNotification(
              "Success",
              `Cleared orders for desks ${this.startDesk}-${this.endDesk}`
            );
          } catch (error) {
            console.error(error);
            this.loadOrders(true);
          }
        }

        showNotification(title, message) {
          const el = document.getElementById("notification");
          document.getElementById("notificationTitle").textContent = title;
          document.getElementById("notificationMessage").textContent = message;
          el.classList.add("show");

          const sound = document.getElementById("notificationSound");
          if (sound) {
            sound.pause();
            sound.currentTime = 0;
            sound
              .play()
              .catch((err) => console.warn("Autoplay prevented:", err));
          }

          setTimeout(() => el.classList.remove("show"), 4000);
        }

        destroy() {
          if (this.pollInterval) clearInterval(this.pollInterval);
        }
      }

      let dashboard;
      document.addEventListener("DOMContentLoaded", () => {
        dashboard = new DashboardApp();
      });
      window.addEventListener("beforeunload", () => {
        if (dashboard) dashboard.destroy();
      });
    </script>
  </body>
</html>
